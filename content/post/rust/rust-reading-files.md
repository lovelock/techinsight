---
title: "æ·±åº¦è§£æ Rust ä¸­è¯»å–æ–‡æœ¬æ–‡ä»¶ä¸å­—èŠ‚æµï¼ˆäºŒè¿›åˆ¶æ–‡ä»¶ï¼‰çš„æ ¸å¿ƒæ³¨æ„äº‹é¡¹"
description: 
date: 2025-11-01T23:13:20+08:00
image: 
math: true
license: 
hidden: false
comments: true
categories: ["Rust"]
tags: ["file"]
---


åœ¨ Rust å¼€å‘ä¸­ï¼Œæ–‡ä»¶è¯»å–æ˜¯æä¸ºå¸¸è§çš„æ“ä½œåœºæ™¯ï¼Œè€Œæ–‡æœ¬æ–‡ä»¶ä¸å­—èŠ‚æµï¼ˆäºŒè¿›åˆ¶æ–‡ä»¶ï¼‰çš„è¯»å–é€»è¾‘å› æ•°æ®æ ¼å¼çš„æœ¬è´¨å·®å¼‚ï¼Œå­˜åœ¨æˆªç„¶ä¸åŒçš„å¤„ç†æ€è·¯ä¸æ³¨æ„äº‹é¡¹ã€‚æ–‡æœ¬æ–‡ä»¶ä»¥äººç±»å¯ç†è§£çš„å­—ç¬¦åºåˆ—ä¸ºæ ¸å¿ƒï¼Œéœ€å…³æ³¨ç¼–ç è§£æä¸å­—ç¬¦å®Œæ•´æ€§ï¼›äºŒè¿›åˆ¶æ–‡ä»¶åˆ™ä»¥åŸå§‹å­—èŠ‚ä¸ºè½½ä½“ï¼Œéœ€ä¿éšœæ•°æ®ç»“æ„çš„ç²¾ç¡®è¿˜åŸä¸è¯»å†™ä¸€è‡´æ€§ã€‚æœ¬æ–‡å°†ä»åº•å±‚åŸç†å‡ºå‘ï¼Œç³»ç»Ÿå‰–æä¸¤ç±»æ–‡ä»¶è¯»å–çš„æ ¸å¿ƒæ³¨æ„äº‹é¡¹ï¼Œç»“åˆ Rust æ ‡å‡†åº“ API ä¸å®è·µæ¡ˆä¾‹ï¼Œä¸ºå¼€å‘è€…æä¾›å…¨é¢çš„æ“ä½œæŒ‡å—ï¼Œç¡®ä¿åœ¨ä¸åŒåœºæ™¯ä¸‹å®ç°å®‰å…¨ã€é«˜æ•ˆçš„æ–‡ä»¶è¯»å–ã€‚

## ä¸€ã€è¯»å–æ–‡æœ¬æ–‡ä»¶ï¼šèšç„¦ç¼–ç è§£æä¸å­—ç¬¦å®Œæ•´æ€§

æ–‡æœ¬æ–‡ä»¶çš„æœ¬è´¨æ˜¯ â€œæŒ‰ç‰¹å®šç¼–ç è§„åˆ™å­˜å‚¨çš„å­—ç¬¦åºåˆ—â€ï¼ˆå¦‚ UTF-8ã€GBKã€UTF-16 ç­‰ï¼‰ï¼Œè¯»å–æ—¶çš„æ ¸å¿ƒæŒ‘æˆ˜åœ¨äº**æ­£ç¡®è§£æç¼–ç æ ¼å¼**ä¸**ä¿éšœå­—ç¬¦ä¸è¢«æˆªæ–­**ã€‚Rust æ ‡å‡†åº“è™½é»˜è®¤ä»¥ UTF-8 å¤„ç†æ–‡æœ¬ï¼Œä½†å®é™…å¼€å‘ä¸­éœ€åº”å¯¹å¤šæ ·ç¼–ç åœºæ™¯ï¼ŒåŒæ—¶è§„é¿å› æ–‡ä»¶æŸåã€è¯»å–ä¸å®Œæ•´å¯¼è‡´çš„å­—ç¬¦è§£æé”™è¯¯ã€‚

### 1. ç¼–ç å¤„ç†ï¼šä»é»˜è®¤ UTF-8 åˆ°å¤šç¼–ç å…¼å®¹

Rust æ ‡å‡†åº“ï¼ˆ`std::fs`ï¼‰çš„æ–‡æœ¬è¯»å– APIï¼ˆå¦‚`read_to_string`ï¼‰é»˜è®¤å‡è®¾æ–‡ä»¶ä¸º UTF-8 ç¼–ç ï¼Œè‹¥æ–‡ä»¶é‡‡ç”¨å…¶ä»–ç¼–ç ï¼ˆå¦‚ Windows ç³»ç»Ÿå¸¸è§çš„ GBKã€UTF-16ï¼‰ï¼Œç›´æ¥è¯»å–ä¼šè§¦å‘ç¼–ç é”™è¯¯ï¼Œè¿™æ˜¯æ–‡æœ¬æ–‡ä»¶è¯»å–çš„é¦–è¦æ³¨æ„äº‹é¡¹ã€‚

#### ï¼ˆ1ï¼‰é»˜è®¤ UTF-8 è¯»å–çš„é£é™©ä¸å¤„ç†

ä½¿ç”¨`std::fs::read_to_string`è¯»å–é UTF-8 ç¼–ç æ–‡ä»¶æ—¶ï¼Œä¼šè¿”å›`io::Error`ï¼ˆé”™è¯¯ç±»å‹ä¸º`InvalidData`ï¼‰ï¼Œå¯¼è‡´ç¨‹åºå´©æºƒæˆ–æ•°æ®è¯»å–å¤±è´¥ã€‚ä¾‹å¦‚ï¼Œè¯»å– GBK ç¼–ç çš„ä¸­æ–‡æ–‡æœ¬æ–‡ä»¶ï¼š



```rust
use std::fs;

fn main() {
	// è¯»å– GBK ç¼–ç çš„æ–‡æœ¬æ–‡ä»¶ï¼Œé»˜è®¤ UTF-8 è§£æä¼šå¤±è´¥
	match fs::read_to_string("gbk_text.txt") {
		Ok(content) => println!("å†…å®¹ï¼š{}", content),
		Err(e) => eprintln!("è¯»å–é”™è¯¯ï¼š{}", e), // è¾“å‡º "è¯»å–é”™è¯¯ï¼šinvalid utf-8 sequence of 2 bytes from index 0"
	}
}
```

**æ³¨æ„äº‹é¡¹**ï¼š



* ä¸å¯æƒ³å½“ç„¶åœ°å‡è®¾æ–‡æœ¬æ–‡ä»¶ä¸º UTF-8 ç¼–ç ï¼Œå°¤å…¶æ˜¯åœ¨è·¨å¹³å°åœºæ™¯ï¼ˆå¦‚ Windows ç”Ÿæˆçš„æ–‡ä»¶å¯èƒ½ä¸º GBK æˆ– UTF-16ï¼‰æˆ–å¤„ç†ç¬¬ä¸‰æ–¹æ–‡ä»¶æ—¶ï¼Œéœ€å…ˆæ˜ç¡®æ–‡ä»¶ç¼–ç æ ¼å¼ã€‚

* è‹¥æ— æ³•ç¡®å®šç¼–ç ï¼Œéœ€é€šè¿‡æ–‡ä»¶å¤´æ ‡è¯†ï¼ˆå¦‚ UTF-8 BOMã€UTF-16 BOMï¼‰æˆ–å¤–éƒ¨é…ç½®è·å–ç¼–ç ä¿¡æ¯ï¼Œé¿å…ç›²ç›®è¯»å–ã€‚

#### ï¼ˆ2ï¼‰å¤šç¼–ç æ”¯æŒï¼šå€ŸåŠ©ç¬¬ä¸‰æ–¹åº“å®ç°å…¼å®¹

Rust æ ‡å‡†åº“æœªæä¾›å¤šç¼–ç è§£æèƒ½åŠ›ï¼Œéœ€ä¾èµ–ç¬¬ä¸‰æ–¹åº“ï¼ˆå¦‚`encoding_rs`ã€`chardet`ï¼‰å®ç° GBKã€Shift-JIS ç­‰ç¼–ç çš„è§£æã€‚å…¶ä¸­`encoding_rs`æ˜¯ Rust ç”Ÿæ€ä¸­ä¸»æµçš„ç¼–ç å¤„ç†åº“ï¼Œæ”¯æŒç»å¤§å¤šæ•°å¸¸è§ç¼–ç ï¼Œä¸”æ€§èƒ½é«˜æ•ˆã€æ—  unsafe ä»£ç ã€‚

**å®è·µæ¡ˆä¾‹ï¼šè¯»å– GBK ç¼–ç æ–‡æœ¬æ–‡ä»¶**



1. åœ¨`Cargo.toml`ä¸­æ·»åŠ ä¾èµ–ï¼š



```toml
[dependencies]
encoding_rs = "0.8"
```

1. å®ç° GBK ç¼–ç è§£æï¼š

```rust
use std::fs;
use encoding_rs::GBK;

fn read_gbk_file(path: &str) -> Result<String, Box<dyn std::error::Error>> {
	// 1. å…ˆä»¥å­—èŠ‚æµå½¢å¼è¯»å–æ–‡ä»¶ï¼ˆé¿å…ç¼–ç è§£æå¹²æ‰°ï¼‰
	let bytes = fs::read(path)?;

	// 2. ä½¿ç”¨ GBK ç¼–ç è§£æå­—èŠ‚æµï¼Œå¿½ç•¥æ— æ•ˆå­—èŠ‚ï¼ˆæˆ–æ ¹æ®éœ€æ±‚å¤„ç†ï¼‰
	let (content, _, had_errors) = GBK.decode(&bytes);

	// 3. å¤„ç†ç¼–ç é”™è¯¯ï¼ˆå¯é€‰ï¼šæ ¹æ®ä¸šåŠ¡éœ€æ±‚å†³å®šæ˜¯å¦ç»ˆæ­¢ç¨‹åºï¼‰
	if had_errors {
		eprintln!("è­¦å‘Šï¼šæ–‡ä»¶å­˜åœ¨æ— æ•ˆ GBK ç¼–ç å­—ç¬¦ï¼Œå·²å¿½ç•¥");
	}

	Ok(content.into_owned())
}

fn main() {
	match read_gbk_file("gbk_text.txt") {
		Ok(content) => println!("GBK æ–‡æœ¬å†…å®¹ï¼š{}", content),
		Err(e) => eprintln!("è¯»å–é”™è¯¯ï¼š{}", e),
	}
}
```

**æ³¨æ„äº‹é¡¹**ï¼š



* è§£æç¼–ç æ—¶éœ€æ˜ç¡® â€œé”™è¯¯å¤„ç†ç­–ç•¥â€ï¼šæ˜¯å¿½ç•¥æ— æ•ˆå­—èŠ‚ï¼ˆå¦‚ä¸Šè¿°æ¡ˆä¾‹ï¼‰ã€æ›¿æ¢ä¸ºå ä½ç¬¦ï¼ˆå¦‚`ï¿½`ï¼‰ï¼Œè¿˜æ˜¯ç›´æ¥è¿”å›é”™è¯¯ç»ˆæ­¢ç¨‹åºï¼Œéœ€æ ¹æ®ä¸šåŠ¡åœºæ™¯ï¼ˆå¦‚æ—¥å¿—åˆ†æã€ç”¨æˆ·æ–‡æ¡£è¯»å–ï¼‰å†³å®šã€‚

* å¯¹äº UTF-16 ç¼–ç æ–‡ä»¶ï¼ˆå¸¸è§äº Windows ç³»ç»Ÿï¼‰ï¼Œéœ€åŒºåˆ† â€œå¤§ç«¯åºï¼ˆUTF-16BEï¼‰â€ ä¸ â€œå°ç«¯åºï¼ˆUTF-16LEï¼‰â€ï¼Œå¯é€šè¿‡æ–‡ä»¶å¤´çš„ BOMï¼ˆå­—èŠ‚é¡ºåºæ ‡è®°ï¼Œ0xFEFFï¼‰è‡ªåŠ¨åˆ¤æ–­ç¼–ç ç«¯åºï¼Œé¿å…å­—ç¬¦é”™ä¹±ã€‚

### 2. å­—ç¬¦å®Œæ•´æ€§ï¼šè§„é¿éƒ¨åˆ†è¯»å–å¯¼è‡´çš„æˆªæ–­é—®é¢˜

æ–‡æœ¬æ–‡ä»¶çš„è¯»å–å¯èƒ½å›  â€œéƒ¨åˆ†è¯»å–â€ï¼ˆå¦‚ä½¿ç”¨`read`æ–¹æ³•è¯»å–å›ºå®šå¤§å°ç¼“å†²åŒºï¼‰å¯¼è‡´å­—ç¬¦è¢«æˆªæ–­ â€”â€” å°¤å…¶æ˜¯ UTF-8 ç¼–ç ä¸­ï¼Œä¸€ä¸ªå­—ç¬¦å¯èƒ½å ç”¨ 1~4 å­—èŠ‚ï¼Œè‹¥ç¼“å†²åŒºæ°å¥½æˆªæ–­æŸä¸ªå­—ç¬¦çš„ä¸­é—´å­—èŠ‚ï¼Œä¼šå¯¼è‡´åç»­è§£æå¤±è´¥ã€‚

#### ï¼ˆ1ï¼‰é¿å…ä½¿ç”¨å›ºå®šç¼“å†²åŒºç›´æ¥è¯»å–æ–‡æœ¬

Rust çš„`std::fs::File`ç±»å‹å®ç°äº†`Read` traitï¼Œå…¶`read`æ–¹æ³•ä¼šå°è¯•è¯»å–æŒ‡å®šå¤§å°çš„å­—èŠ‚åˆ°ç¼“å†²åŒºï¼Œä½†æ— æ³•ä¿è¯è¯»å–çš„å­—èŠ‚æ°å¥½æ„æˆå®Œæ•´å­—ç¬¦ã€‚ä¾‹å¦‚ï¼š

```rust
use std::fs::File;
use std::io::Read;

fn main() {
	let mut file = File::open("utf8_text.txt").unwrap();
	let mut buf = [0u8; 3]; // ç¼“å†²åŒºå¤§å°ä¸º 3 å­—èŠ‚ï¼ˆå¯èƒ½æˆªæ–­ UTF-8 å­—ç¬¦ï¼‰
	let mut content = String::new();

	// éƒ¨åˆ†è¯»å–å¯èƒ½å¯¼è‡´å­—ç¬¦æˆªæ–­
	loop {
		match file.read(&mut buf) {
			Ok(0) => break, // è¯»å–ç»“æŸ
			Ok(n) => {
				// è‹¥ buf[0..n] æ°å¥½æˆªæ–­ UTF-8 å­—ç¬¦ï¼Œfrom_utf8 ä¼šæŠ¥é”™
				let s = String::from_utf8(buf[0..n].to_vec()).unwrap();
				content.push_str(&s);
			}
			Err(e) => panic!("è¯»å–é”™è¯¯ï¼š{}", e),
		}
	}
}
```

ä¸Šè¿°ä»£ç ä¸­ï¼Œè‹¥æ–‡ä»¶åŒ…å«å ç”¨ 4 å­—èŠ‚çš„ UTF-8 å­—ç¬¦ï¼ˆå¦‚ emoji è¡¨æƒ…`ğŸ˜€`ï¼‰ï¼Œç¼“å†²åŒºå¤§å°ä¸º 3 å­—èŠ‚æ—¶ï¼Œä¼šæˆªæ–­è¯¥å­—ç¬¦çš„æœ€å 1 å­—èŠ‚ï¼Œå¯¼è‡´`from_utf8`è°ƒç”¨å¤±è´¥ã€‚

**æ³¨æ„äº‹é¡¹**ï¼š



* é™¤éæ˜ç¡®çŸ¥é“æ–‡æœ¬æ–‡ä»¶çš„ç¼–ç ä¸º â€œå›ºå®šå®½åº¦ç¼–ç â€ï¼ˆå¦‚ UTF-32ï¼‰ï¼Œå¦åˆ™ä¸è¦ä½¿ç”¨`read`æ–¹æ³•ç»“åˆå›ºå®šç¼“å†²åŒºè¯»å–æ–‡æœ¬ï¼Œåº”ä¼˜å…ˆä½¿ç”¨ä¸“ä¸ºæ–‡æœ¬è®¾è®¡çš„ APIã€‚

#### ï¼ˆ2ï¼‰ä½¿ç”¨æ–‡æœ¬å‹å¥½å‹ API ä¿éšœå­—ç¬¦å®Œæ•´æ€§

Rust æ ‡å‡†åº“ä¸ç¬¬ä¸‰æ–¹åº“æä¾›äº†å¤šç§ â€œå­—ç¬¦æ„ŸçŸ¥â€ çš„æ–‡æœ¬è¯»å– APIï¼Œå¯è‡ªåŠ¨å¤„ç†å­—ç¬¦æˆªæ–­é—®é¢˜ï¼Œæ ¸å¿ƒåŒ…æ‹¬ï¼š



* `std::fs::read_to_string`ï¼šä¸€æ¬¡æ€§è¯»å–æ•´ä¸ªæ–‡ä»¶åˆ°å­—ç¬¦ä¸²ï¼Œå†…éƒ¨è‡ªåŠ¨å¤„ç† UTF-8 ç¼–ç ä¸å­—ç¬¦å®Œæ•´æ€§ï¼Œé€‚åˆä¸­å°å‹æ–‡æœ¬æ–‡ä»¶ï¼ˆé¿å…å†…å­˜æº¢å‡ºï¼‰ã€‚

* `std::io::BufRead`**&#x20;trait**ï¼šæä¾›æŒ‰è¡Œè¯»å–ï¼ˆ`lines`æ–¹æ³•ï¼‰æˆ–æŒ‰å­—ç¬¦è¯»å–ï¼ˆ`chars`æ–¹æ³•ï¼‰çš„èƒ½åŠ›ï¼Œå†…éƒ¨é€šè¿‡ç¼“å†²åŒºè‡ªåŠ¨ç¼“å­˜ä¸å®Œæ•´å­—ç¬¦ï¼Œç¡®ä¿æ¯æ¬¡è¯»å–çš„å•å…ƒï¼ˆè¡Œ / å­—ç¬¦ï¼‰å®Œæ•´ã€‚

**å®è·µæ¡ˆä¾‹ï¼šæŒ‰è¡Œè¯»å–å¤§å‹æ–‡æœ¬æ–‡ä»¶**

å¯¹äºå¤§å‹æ–‡æœ¬æ–‡ä»¶ï¼ˆå¦‚æ—¥å¿—æ–‡ä»¶ã€CSV æ•°æ®ï¼‰ï¼Œä¸€æ¬¡æ€§è¯»å–ä¼šå ç”¨å¤§é‡å†…å­˜ï¼Œæ­¤æ—¶åº”ä½¿ç”¨`BufRead::lines`æŒ‰è¡Œè¯»å–ï¼Œæ—¢ä¿éšœå­—ç¬¦å®Œæ•´æ€§ï¼Œåˆé™ä½å†…å­˜å¼€é”€ï¼š



```rust
use std::fs::File;
use std::io::{BufRead, BufReader};
fn read_large_text_file(path: &str) -> Result<(), Box<dyn std::error::Error>> {

	let file = File::open(path)?;
	let reader = BufReader::new(file); // åŒ…è£…ä¸ºå¸¦ç¼“å†²åŒºçš„è¯»å–å™¨ï¼ˆé»˜è®¤ç¼“å†²åŒºå¤§å° 8KBï¼Œå¯è‡ªå®šä¹‰ï¼‰

	// æŒ‰è¡Œè¯»å–ï¼Œè‡ªåŠ¨å¤„ç†æ¢è¡Œç¬¦ä¸å­—ç¬¦å®Œæ•´æ€§
	for (line_num, line_result) in reader.lines().enumerate() {
		let line = line_result?; // å¤„ç†å¯èƒ½çš„ IO é”™è¯¯ï¼ˆå¦‚æ–‡ä»¶ä¸­é€”æŸåï¼‰
		println!("ç¬¬ {} è¡Œï¼š{}", line_num + 1, line);
	}
	Ok(())
}

fn main() {
	if let Err(e) = read_large_text_file("large_log.txt") {
		eprintln!("è¯»å–é”™è¯¯ï¼š{}", e);
	}
}
```

**æ³¨æ„äº‹é¡¹**ï¼š



* `BufRead::lines`ä¼šè‡ªåŠ¨å¿½ç•¥è¡Œå°¾çš„æ¢è¡Œç¬¦ï¼ˆ`\n`æˆ–`\r\n`ï¼‰ï¼Œè‹¥éœ€ä¿ç•™åŸå§‹æ¢è¡Œç¬¦ï¼Œéœ€ä½¿ç”¨`read_line`æ–¹æ³•æ‰‹åŠ¨å¤„ç†ã€‚

* å¯¹äºè¶…å¤§å‹æ–‡ä»¶ï¼ˆå¦‚ GB çº§ï¼‰ï¼Œéœ€æ³¨æ„å†…å­˜å ç”¨ï¼š`BufReader`çš„ç¼“å†²åŒºå¤§å°é»˜è®¤ä¸º 8KBï¼Œå¯é€šè¿‡`BufReader::with_capacity`è°ƒæ•´ï¼ˆå¦‚è®¾ç½®ä¸º 64KBï¼‰ï¼Œå¹³è¡¡ IO æ¬¡æ•°ä¸å†…å­˜å¼€é”€ã€‚

### 3. å…¶ä»–å…³é”®æ³¨æ„äº‹é¡¹

#### ï¼ˆ1ï¼‰æ–‡ä»¶æƒé™ä¸è·¯å¾„å¤„ç†



* è¯»å–æ–‡ä»¶å‰éœ€ç¡®ä¿ç¨‹åºæ‹¥æœ‰æ–‡ä»¶çš„ â€œè¯»æƒé™â€ï¼Œå¦åˆ™ä¼šè¿”å›`PermissionDenied`é”™è¯¯ã€‚åœ¨è·¨å¹³å°åœºæ™¯ä¸­ï¼Œéœ€æ³¨æ„ä¸åŒç³»ç»Ÿçš„æƒé™æ¨¡å‹ï¼ˆå¦‚ Linux çš„`rwx`æƒé™ã€Windows çš„ ACL æƒé™ï¼‰ã€‚

* ä½¿ç”¨`std::path::Path`æˆ–`PathBuf`å¤„ç†æ–‡ä»¶è·¯å¾„ï¼Œé¿å…ç¡¬ç¼–ç å­—ç¬¦ä¸²è·¯å¾„ï¼ˆå¦‚`"C:\\text.txt"`ä»…é€‚ç”¨äº Windowsï¼Œ`"/home/text.txt"`ä»…é€‚ç”¨äº Linuxï¼‰ï¼Œç¡®ä¿è·¯å¾„è§£æçš„è·¨å¹³å°å…¼å®¹æ€§ã€‚ä¾‹å¦‚ï¼š



```rust
use std::path::Path;
use std::fs;
fn main() {
	let path = Path::new("text.txt"); // è·¨å¹³å°è·¯å¾„è¡¨ç¤º

	if path.exists() && path.is_file() { // å…ˆæ£€æŸ¥æ–‡ä»¶æ˜¯å¦å­˜åœ¨ä¸”ä¸ºæ™®é€šæ–‡ä»¶
		let content = fs::read_to_string(path).unwrap();
		println!("å†…å®¹ï¼š{}", content);
	} else {
		eprintln!("é”™è¯¯ï¼šæ–‡ä»¶ä¸å­˜åœ¨æˆ–ä¸æ˜¯æ™®é€šæ–‡ä»¶");
	}
}
```

#### ï¼ˆ2ï¼‰æ–‡ä»¶ç¼–ç æ ‡è¯†çš„å¤„ç†



* éƒ¨åˆ†æ–‡æœ¬æ–‡ä»¶ä¼šåœ¨å¼€å¤´æ·»åŠ  â€œç¼–ç æ ‡è¯†â€ï¼ˆå¦‚ UTF-8 BOMã€UTF-16 BOMï¼‰ï¼Œè™½ç„¶ Rust æ ‡å‡†åº“çš„`read_to_string`ä¼šè‡ªåŠ¨å¿½ç•¥ UTF-8 BOMï¼ˆ0xEFBBBFï¼‰ï¼Œä½†å…¶ä»–ç¼–ç çš„ BOM éœ€æ‰‹åŠ¨å¤„ç†ï¼ˆå¦‚ UTF-16 BOM ç”¨äºåˆ¤æ–­ç«¯åºï¼‰ã€‚

* è‹¥æ–‡ä»¶æ— ç¼–ç æ ‡è¯†ï¼Œä¸”æ— æ³•é€šè¿‡å¤–éƒ¨ä¿¡æ¯ç¡®å®šç¼–ç ï¼Œå¯ä½¿ç”¨`chardet`åº“è‡ªåŠ¨æ£€æµ‹ç¼–ç ï¼ˆåŸºäºå­—èŠ‚é¢‘ç‡åˆ†æï¼‰ï¼Œä½†æ£€æµ‹ç»“æœå­˜åœ¨ä¸€å®šè¯¯å·®ï¼Œéœ€åœ¨å…³é”®åœºæ™¯ä¸­ç»“åˆäººå·¥ç¡®è®¤ã€‚

## äºŒã€è¯»å–å­—èŠ‚æµï¼ˆäºŒè¿›åˆ¶æ–‡ä»¶ï¼‰ï¼šèšç„¦æ•°æ®ç»“æ„è¿˜åŸä¸è¯»å†™ä¸€è‡´æ€§

å­—èŠ‚æµï¼ˆäºŒè¿›åˆ¶æ–‡ä»¶ï¼‰çš„æœ¬è´¨æ˜¯ â€œæŒ‰ç‰¹å®šæ ¼å¼å­˜å‚¨çš„åŸå§‹å­—èŠ‚åºåˆ—â€ï¼ˆå¦‚å›¾ç‰‡ã€éŸ³é¢‘ã€è‡ªå®šä¹‰äºŒè¿›åˆ¶åè®®æ•°æ®ï¼‰ï¼Œè¯»å–æ—¶çš„æ ¸å¿ƒæŒ‘æˆ˜åœ¨äº**ç²¾ç¡®è¿˜åŸæ•°æ®ç»“æ„**ä¸**ä¿éšœå­—èŠ‚çº§åˆ«çš„å®Œæ•´æ€§**ã€‚ä¸æ–‡æœ¬æ–‡ä»¶ä¸åŒï¼ŒäºŒè¿›åˆ¶æ–‡ä»¶çš„è¯»å–æ— éœ€ç¼–ç è§£æï¼Œä½†éœ€ä¸¥æ ¼éµå¾ªæ•°æ®çš„å­˜å‚¨æ ¼å¼ï¼ˆå¦‚ç»“æ„ä½“å¯¹é½ã€å­—èŠ‚åºï¼‰ï¼Œå¦åˆ™ä¼šå¯¼è‡´æ•°æ®è§£æé”™è¯¯ã€‚

### 1. æ•°æ®ç»“æ„å¯¹é½ä¸å­—èŠ‚åºï¼šé¿å…å†…å­˜å¸ƒå±€ä¸åŒ¹é…

äºŒè¿›åˆ¶æ–‡ä»¶ä¸­çš„æ•°æ®é€šå¸¸æŒ‰ç‰¹å®š â€œç»“æ„ä½“â€ æ ¼å¼å­˜å‚¨ï¼ˆå¦‚è‡ªå®šä¹‰çš„`Header`ã€`Record`ç»“æ„ï¼‰ï¼Œè€Œ Rust ç»“æ„ä½“çš„å†…å­˜å¸ƒå±€å¯èƒ½å›  â€œå¯¹é½ä¼˜åŒ–â€ ä¸æ–‡ä»¶ä¸­çš„å­˜å‚¨æ ¼å¼ä¸ä¸€è‡´ï¼Œç›´æ¥ä½¿ç”¨`std::mem::transmute`æˆ–`read_exact`è¯»å–ç»“æ„ä½“å¯èƒ½å¯¼è‡´æ•°æ®é”™ä¹±ã€‚

#### ï¼ˆ1ï¼‰ç»“æ„ä½“å¯¹é½çš„é—®é¢˜ä¸è§£å†³

Rust ç¼–è¯‘å™¨ä¼šè‡ªåŠ¨å¯¹ç»“æ„ä½“æˆå‘˜è¿›è¡Œå†…å­˜å¯¹é½ï¼ˆå¦‚`i32`æˆå‘˜é€šå¸¸å¯¹é½åˆ° 4 å­—èŠ‚è¾¹ç•Œï¼‰ï¼Œä»¥æå‡è®¿é—®æ€§èƒ½ï¼Œä½†äºŒè¿›åˆ¶æ–‡ä»¶ä¸­çš„æ•°æ®å¯èƒ½æŒ‰ â€œç´§å‡‘æ ¼å¼â€ å­˜å‚¨ï¼ˆæ— å¯¹é½å¡«å……å­—èŠ‚ï¼‰ï¼Œæ­¤æ—¶ç›´æ¥æ˜ å°„ç»“æ„ä½“å°†è¯»å–åˆ°æ— æ•ˆçš„å¡«å……å­—èŠ‚ã€‚ä¾‹å¦‚ï¼š

```rust
// Rust ä¸­çš„ç»“æ„ä½“ï¼ˆå­˜åœ¨å¯¹é½å¡«å……ï¼‰
#[derive(Debug)]
struct FileHeader {
	magic: u16, // 2 å­—èŠ‚
	version: u32, // 4 å­—èŠ‚ï¼ˆç¼–è¯‘å™¨ä¼šåœ¨ magic åæ·»åŠ  2 å­—èŠ‚å¡«å……ï¼Œä½¿ version å¯¹é½åˆ° 4 å­—èŠ‚è¾¹ç•Œï¼‰
	length: u64, // 8 å­—èŠ‚
}

// äºŒè¿›åˆ¶æ–‡ä»¶ä¸­å®é™…çš„å­˜å‚¨æ ¼å¼ï¼ˆç´§å‡‘ï¼Œæ— å¡«å……ï¼‰ï¼šmagic(2) + version(4) + length(8) = 14 å­—èŠ‚
// è€Œ Rust ç»“æ„ä½“çš„å¤§å°ä¸º 2 + 2ï¼ˆå¡«å……ï¼‰ + 4 + 8 = 16 å­—èŠ‚ï¼Œç›´æ¥è¯»å–ä¼šå¯¼è‡´ version æ•°æ®é”™è¯¯
```

**æ³¨æ„äº‹é¡¹**ï¼š



* ä¸å¯ç›´æ¥å°†äºŒè¿›åˆ¶æ–‡ä»¶çš„å­—èŠ‚åºåˆ—å¼ºåˆ¶è½¬æ¢ä¸º Rust ç»“æ„ä½“ï¼Œéœ€ç¦ç”¨ç»“æ„ä½“çš„è‡ªåŠ¨å¯¹é½ä¼˜åŒ–ï¼Œæˆ–æ‰‹åŠ¨æŒ‰å­—æ®µé¡ºåºè¯»å–å­—èŠ‚å¹¶è½¬æ¢ã€‚

#### ï¼ˆ2ï¼‰ç¦ç”¨è‡ªåŠ¨å¯¹é½ï¼šä½¿ç”¨`repr(packed)`å±æ€§

é€šè¿‡`#[repr(packed)]`å±æ€§å¯å¼ºåˆ¶ Rust ç»“æ„ä½“æŒ‰ â€œç´§å‡‘æ ¼å¼â€ å¸ƒå±€ï¼Œæ¶ˆé™¤å¡«å……å­—èŠ‚ï¼Œä½¿å…¶ä¸äºŒè¿›åˆ¶æ–‡ä»¶çš„å­˜å‚¨æ ¼å¼ä¸€è‡´ã€‚ä½†éœ€æ³¨æ„ï¼Œ`repr(packed)`ä¼šç¦ç”¨å†…å­˜å¯¹é½ï¼Œå¯èƒ½å¯¼è‡´è®¿é—®æ€§èƒ½ä¸‹é™ï¼Œä¸”éœ€ä½¿ç”¨`unsafe`ä»£ç è¯»å–ï¼ˆå› æœªå¯¹é½å†…å­˜è®¿é—®åœ¨ Rust ä¸­å±äºæœªå®šä¹‰è¡Œä¸ºï¼‰ã€‚

**å®è·µæ¡ˆä¾‹ï¼šè¯»å–ç´§å‡‘æ ¼å¼çš„äºŒè¿›åˆ¶ç»“æ„ä½“**



```rust
use std::fs::File;
use std::io::Read;
use std::mem;

// ç¦ç”¨è‡ªåŠ¨å¯¹é½ï¼ŒæŒ‰ç´§å‡‘æ ¼å¼å¸ƒå±€ï¼ˆä¸äºŒè¿›åˆ¶æ–‡ä»¶ä¸€è‡´ï¼‰

#[repr(packed)]
#[derive(Debug)]
struct FileHeader {
	magic: u16,
	version: u32,
	length: u64,
}

fn read_file_header(path: &str) -> Result<FileHeader, Box<dyn std::error::Error>> {

	let mut file = File::open(path)?;
	let mut buf = [0u8; mem::size_of::<FileHeader>()]; // ç¼“å†²åŒºå¤§å° = ç»“æ„ä½“å¤§å°ï¼ˆ14 å­—èŠ‚ï¼‰

	// è¯»å–æ°å¥½è¶³å¤Ÿçš„å­—èŠ‚ï¼ˆè‹¥æ–‡ä»¶é•¿åº¦ä¸è¶³ï¼Œä¼šè¿”å›é”™è¯¯ï¼‰
	file.read_exact(&mut buf)?;

	// unsafeï¼šå°†å­—èŠ‚ç¼“å†²åŒºå¼ºåˆ¶è½¬æ¢ä¸ºç»“æ„ä½“ï¼ˆå›  repr(packed) ç¦ç”¨äº†å¯¹é½ï¼Œéœ€ç¡®ä¿å®‰å…¨ï¼‰
	let header = unsafe { mem::transmute::<[u8; mem::size_of::<FileHeader>()], FileHeader>(buf) };

	Ok(header)
}

fn main() {
	match read_file_header("data.bin") {
		Ok(header) => println!("æ–‡ä»¶å¤´ï¼š{:?}", header),
		Err(e) => eprintln!("è¯»å–é”™è¯¯ï¼š{}", e),
	}
}
```

**æ³¨æ„äº‹é¡¹**ï¼š



* `repr(packed)`ä»…é€‚ç”¨äº â€œç»“æ„ä½“å­—æ®µç±»å‹å›ºå®šã€å­˜å‚¨æ ¼å¼ç´§å‡‘â€ çš„åœºæ™¯ï¼Œè‹¥äºŒè¿›åˆ¶æ–‡ä»¶çš„å­—æ®µé¡ºåºä¸ç»“æ„ä½“ä¸ä¸€è‡´ï¼Œä»éœ€æ‰‹åŠ¨è¯»å–æ¯ä¸ªå­—æ®µã€‚

* ä½¿ç”¨`unsafe`ä»£ç æ—¶éœ€æ ¼å¤–è°¨æ…ï¼Œç¡®ä¿ç¼“å†²åŒºå¤§å°ä¸ç»“æ„ä½“å¤§å°å®Œå…¨ä¸€è‡´ï¼Œä¸”æ–‡ä»¶ä¸­çš„æ•°æ®æ ¼å¼ä¸ç»“æ„ä½“å®šä¹‰åŒ¹é…ï¼Œé¿å…å†…å­˜è¶Šç•Œæˆ–æ•°æ®è§£æé”™è¯¯ã€‚

#### ï¼ˆ3ï¼‰å¤„ç†å­—èŠ‚åºï¼ˆå¤§å°ç«¯ï¼‰é—®é¢˜

äºŒè¿›åˆ¶æ–‡ä»¶ä¸­çš„å¤šå­—èŠ‚æ•°æ®ï¼ˆå¦‚`u16`ã€`u32`ï¼‰å¯èƒ½é‡‡ç”¨ â€œå¤§ç«¯åºï¼ˆBig-Endianï¼‰â€ æˆ– â€œå°ç«¯åºï¼ˆLittle-Endianï¼‰â€ å­˜å‚¨ï¼Œè€Œ Rust ç¨‹åºé»˜è®¤ä½¿ç”¨ â€œä¸»æœºå­—èŠ‚åºâ€ï¼ˆå³è¿è¡Œå¹³å°çš„å­—èŠ‚åºï¼Œå¦‚ x86_64 å¹³å°ä¸ºå°ç«¯åºï¼‰ï¼Œè‹¥æ–‡ä»¶å­—èŠ‚åºä¸ä¸»æœºå­—èŠ‚åºä¸ä¸€è‡´ï¼Œç›´æ¥è¯»å–ä¼šå¯¼è‡´æ•°æ®é”™è¯¯ï¼ˆå¦‚æ–‡ä»¶ä¸­ 0x1234 å­˜å‚¨ä¸ºå¤§ç«¯åºï¼Œç›´æ¥è¯»å–ä¸ºå°ç«¯åºä¼šå˜æˆ 0x3412ï¼‰ã€‚

**è§£å†³æ–¹æ³•ï¼šä½¿ç”¨**`byteorder`**åº“å¤„ç†å­—èŠ‚åº**

`byteorder`æ˜¯ Rust ç”Ÿæ€ä¸­å¤„ç†å­—èŠ‚åºçš„ä¸»æµåº“ï¼Œæ”¯æŒåœ¨è¯»å–å¤šå­—èŠ‚æ•°æ®æ—¶æ˜¾å¼æŒ‡å®šå­—èŠ‚åºï¼ˆå¤§ç«¯åº / å°ç«¯åºï¼‰ï¼Œæ— éœ€æ‰‹åŠ¨è½¬æ¢å­—èŠ‚ã€‚



1. åœ¨`Cargo.toml`ä¸­æ·»åŠ ä¾èµ–ï¼š

```toml
[dependencies]
byteorder = "1.5"
```



1. å®è·µæ¡ˆä¾‹ï¼šè¯»å–å¤§ç«¯åºçš„äºŒè¿›åˆ¶æ•°æ®

```rust
use std::fs::File;
use std::io::{Read, Seek, SeekFrom};
use byteorder::{BigEndian, ReadBytesExt};

#[derive(Debug)]
struct SensorData {
	id: u16, // å¤§ç«¯åºå­˜å‚¨
	temperature: f32, // å¤§ç«¯åºå­˜å‚¨ï¼ˆIEEE 754 å•ç²¾åº¦æµ®ç‚¹æ•°ï¼‰
	timestamp: u64, // å¤§ç«¯åºå­˜å‚¨
}

fn read_sensor_data(path: &str) -> Result<Vec<SensorData>, Box<dyn std::error::Error>> {
	let mut file = File::open(path)?;
	let file_size = file.seek(SeekFrom::End(0))?;
}
```
